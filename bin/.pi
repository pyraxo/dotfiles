#!/bin/bash

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && cd .. && pwd)"
TMP_DIR="$SCRIPT_DIR/tmp"

# Function to display usage
usage() {
    echo "Usage: .pi [init]"
    echo ""
    echo "Commands:"
    echo "  .pi        Prepare existing project for AI agentic coding"
    echo "  .pi init   Create new project and prepare it"
    echo ""
    echo "Description:"
    echo "  Interactive command to set up your project with:"
    echo "  - Claude Code Infrastructure"
    echo "  - Beads issue tracking"
    echo "  - Codex-1up documentation"
    echo ""
    echo "Options:"
    echo "  -h, --help    Show this help message and exit"
    exit 1
}

# Function to prompt yes/no questions
ask_yes_no() {
    local question="$1"
    local response

    while true; do
        echo -e "${BLUE}${question} (y/n):${NC} "
        read -r response
        case "$response" in
            [Yy]* ) return 0;;
            [Nn]* ) return 1;;
            * ) echo "Please answer y or n.";;
        esac
    done
}

# Function to check if codex or claude is installed
check_ai_tools() {
    echo -e "\n${BLUE}Checking for AI coding tools...${NC}"

    local has_codex=false
    local has_claude=false

    if command -v codex &> /dev/null; then
        echo -e "${GREEN}✓ Codex is installed${NC}"
        has_codex=true
    fi

    if command -v claude &> /dev/null; then
        echo -e "${GREEN}✓ Claude Code is installed${NC}"
        has_claude=true
    fi

    if [ "$has_codex" = false ] && [ "$has_claude" = false ]; then
        echo -e "${YELLOW}Neither Codex nor Claude Code is installed.${NC}"
        echo -e "${YELLOW}Please run the ai-setup script to install AI coding tools.${NC}"

        if ask_yes_no "Would you like to run ai-setup now?"; then
            if [ -f "$SCRIPT_DIR/scripts/ai-setup.sh" ]; then
                bash "$SCRIPT_DIR/scripts/ai-setup.sh"
            else
                echo -e "${RED}Error: ai-setup script not found at $SCRIPT_DIR/scripts/ai-setup.sh${NC}"
                exit 1
            fi
        else
            echo -e "${YELLOW}Continuing without AI tools installed...${NC}"
        fi
    fi
}

# Function to check and install beads
check_beads() {
    echo -e "\n${BLUE}Checking for Beads issue tracking...${NC}"

    if [ -d ".beads" ]; then
        echo -e "${GREEN}✓ Beads is already initialized in this project${NC}"
        return 0
    fi

    if ! command -v bd &> /dev/null; then
        echo -e "${YELLOW}Beads is not installed.${NC}"
        if ask_yes_no "Would you like to install Beads?"; then
            echo -e "${BLUE}Installing Beads...${NC}"
            curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash

            # Source the shell configuration to get bd command available
            if [ -f "$HOME/.bashrc" ]; then
                source "$HOME/.bashrc"
            elif [ -f "$HOME/.zshrc" ]; then
                source "$HOME/.zshrc"
            fi

            echo -e "${GREEN}✓ Beads installed successfully${NC}"
        else
            echo -e "${YELLOW}Skipping Beads installation${NC}"
            return 1
        fi
    else
        echo -e "${GREEN}✓ Beads is installed${NC}"
    fi

    # Initialize beads in the project
    if ask_yes_no "Would you like to initialize Beads in this project?"; then
        echo -e "${BLUE}Initializing Beads...${NC}"
        bd init
        echo -e "${GREEN}✓ Beads initialized${NC}"
        return 0
    else
        echo -e "${YELLOW}Skipping Beads initialization${NC}"
        return 1
    fi
}

# Function to set up docs folder
setup_docs_folder() {
    echo -e "\n${BLUE}Setting up documentation structure...${NC}"

    if ask_yes_no "Would you like to set up the docs folder?"; then
        mkdir -p docs/{plans,scratchpad,guides}
        echo -e "${GREEN}✓ Created docs/plans, docs/scratchpad, and docs/guides${NC}"

        # Create CLAUDE.md template
        cat > docs/CLAUDE.md << 'EOF'
# Documentation Guidelines for AI Agents

## File Naming Convention

All files in the `docs/` directory should follow this naming convention:

```
YYYYMMDD-{descriptive-file-name}.md
```

### Examples:
- `20250110-authentication-redesign.md`
- `20250110-database-migration-plan.md`
- `20250110-api-endpoints-overview.md`

## Directory Structure

- **docs/plans/** - Project plans, feature specifications, and roadmaps
- **docs/scratchpad/** - Temporary notes, ideas, and working documents
- **docs/guides/** - How-to guides, setup instructions, and reference materials

## Guidelines

1. Always prefix files with the date in YYYYMMDD format
2. Use lowercase with hyphens for file names
3. Be descriptive but concise in file names
4. Update this file if you add new documentation categories
EOF

        echo -e "${GREEN}✓ Created docs/CLAUDE.md with guidelines${NC}"
        echo -e "${BLUE}Note: All docs should follow the YYYYMMDD-{file-name}.md format${NC}"
    else
        echo -e "${YELLOW}Skipping docs folder setup${NC}"
    fi
}

# Function to set up Claude Code infrastructure
setup_cc_infra() {
    echo -e "\n${BLUE}Setting up Claude Code Infrastructure...${NC}"

    if ask_yes_no "Would you like to set up Claude Code infrastructure?"; then
        # Create tmp directory if it doesn't exist
        mkdir -p "$TMP_DIR"

        local cc_infra_path="$TMP_DIR/claude-code-infrastructure-showcase"

        # Clone the repository if it doesn't exist
        if [ ! -d "$cc_infra_path" ]; then
            echo -e "${BLUE}Cloning Claude Code Infrastructure repository...${NC}"
            git clone https://github.com/diet103/claude-code-infrastructure-showcase.git "$cc_infra_path"
        else
            echo -e "${BLUE}Repository already exists, pulling latest changes...${NC}"
            cd "$cc_infra_path" && git pull && cd - > /dev/null
        fi

        echo -e "\n${GREEN}✓ Claude Code Infrastructure repository ready${NC}"
        echo -e "\n${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${YELLOW}Next Step:${NC}"
        echo -e "Paste the following into Claude Code/Codex to integrate the infrastructure:\n"
        echo -e "${BLUE}Carry out the integration plan in @$cc_infra_path/CLAUDE_INTEGRATION_GUIDE.md${NC}"
        echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
    else
        echo -e "${YELLOW}Skipping Claude Code infrastructure setup${NC}"
    fi
}

# Function to set up codex-1up
setup_codex_1up() {
    echo -e "\n${BLUE}Setting up Codex-1up...${NC}"

    if ask_yes_no "Would you like to set up Codex-1up?"; then
        # Check if npm is installed
        if ! command -v npm &> /dev/null; then
            echo -e "${RED}Error: npm is not installed. Please install Node.js and npm first.${NC}"
            return 1
        fi

        # Check if codex-1up is already installed
        if command -v codex-1up &> /dev/null; then
            echo -e "${GREEN}✓ Codex-1up is already installed${NC}"
        else
            echo -e "${BLUE}Installing Codex-1up globally...${NC}"
            npm install -g codex-1up
            echo -e "${GREEN}✓ Codex-1up installed globally${NC}"
        fi

        # Run codex-1up install
        echo -e "${BLUE}Running codex-1up install...${NC}"
        codex-1up install
        echo -e "${GREEN}✓ Codex-1up setup complete${NC}"
    else
        echo -e "${YELLOW}Skipping Codex-1up setup${NC}"
    fi
}

# Function to handle new project initialization
handle_init() {
    echo -e "${BLUE}Creating new project...${NC}"
    echo -e "${BLUE}Enter the folder name for your new project:${NC} "
    read -r folder_name

    if [ -z "$folder_name" ]; then
        echo -e "${RED}Error: Folder name cannot be empty${NC}"
        exit 1
    fi

    # Create the project folder
    mkdir -p "$folder_name"
    cd "$folder_name"

    # Initialize git if not already a git repo
    if [ ! -d ".git" ]; then
        git init
        echo -e "${GREEN}✓ Initialized git repository${NC}"
    fi

    echo -e "${GREEN}✓ Created project folder: $folder_name${NC}"
    echo -e "${BLUE}Now setting up the project...${NC}\n"

    # Run the main setup workflow
    run_main_workflow
}

# Function to run the main setup workflow
run_main_workflow() {
    local current_dir=$(pwd)
    echo -e "${GREEN}Setting up project at: $current_dir${NC}\n"

    # Step 1: Check AI tools
    check_ai_tools

    # Step 2: Check and install beads
    local beads_installed=$?
    check_beads
    beads_installed=$?

    # Step 3: If beads is not being created, ask about docs folder
    if [ $beads_installed -ne 0 ]; then
        setup_docs_folder
    else
        echo -e "${BLUE}Beads is installed. You can use bd for issue tracking.${NC}"
        echo -e "${BLUE}Skipping docs folder setup (Beads handles documentation).${NC}"
    fi

    # Step 4: Set up Claude Code infrastructure
    setup_cc_infra

    # Step 5: Set up Codex-1up
    setup_codex_1up

    echo -e "\n${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✓ Project initialization complete!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
}

# Main script logic
if [ $# -eq 0 ]; then
    # Run main workflow in current directory
    run_main_workflow
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    init)
        handle_init
        ;;
    --help|-h)
        usage
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$COMMAND'${NC}"
        usage
        ;;
esac
