#!/bin/bash
#
# claude-skills - Symlink Claude skills to dotfiles
#
# Usage: claude-skills [-D|--delete]
#
# Creates a symlink from ~/.claude/skills to the dotfiles skills folder.
# Use -D or --delete to remove the symlink.

set -eu

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

# Source shared libraries
# shellcheck source=../lib/logging.sh
source "$REPO_DIR/lib/logging.sh"

CLAUDE_DIR="$HOME/.claude"
SKILLS_SOURCE="$REPO_DIR/skills"
SKILLS_TARGET="$CLAUDE_DIR/skills"

usage() {
    echo "Usage: claude-skills [-D|--delete]"
    echo ""
    echo "Options:"
    echo "  -D, --delete    Remove the skills symlink"
    echo "  -h, --help      Show this help message"
}

delete_symlink() {
    if [ -L "$SKILLS_TARGET" ]; then
        rm "$SKILLS_TARGET"
        success "Removed symlink: $SKILLS_TARGET"
    elif [ -e "$SKILLS_TARGET" ]; then
        fail "$SKILLS_TARGET exists but is not a symlink"
        exit 1
    else
        info "No symlink exists at $SKILLS_TARGET"
    fi
}

create_symlink() {
    # Ensure source exists
    if [ ! -d "$SKILLS_SOURCE" ]; then
        die "Skills directory not found: $SKILLS_SOURCE"
    fi

    # Create ~/.claude if it doesn't exist
    if [ ! -d "$CLAUDE_DIR" ]; then
        mkdir -p "$CLAUDE_DIR"
        info "Created directory: $CLAUDE_DIR"
    fi

    # Handle existing target
    if [ -L "$SKILLS_TARGET" ]; then
        current_target=$(readlink "$SKILLS_TARGET")
        if [ "$current_target" = "$SKILLS_SOURCE" ]; then
            success "Symlink already exists: $SKILLS_TARGET -> $SKILLS_SOURCE"
            return
        else
            warn "Removing existing symlink pointing to: $current_target"
            rm "$SKILLS_TARGET"
        fi
    elif [ -e "$SKILLS_TARGET" ]; then
        if [ -d "$SKILLS_TARGET" ]; then
            warn "$SKILLS_TARGET exists and is not a symlink."
            echo ""

            # Check for skills in the directory
            skill_count=0
            for skill in "$SKILLS_TARGET"/*; do
                if [ -d "$skill" ]; then
                    if [ $skill_count -eq 0 ]; then
                        info "Found the following skills:"
                    fi
                    echo "  - $(basename "$skill")"
                    ((skill_count++))
                fi
            done

            if [ $skill_count -gt 0 ]; then
                echo ""
                read -p "Move these skills to $SKILLS_SOURCE? [y/N] " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                    # Move all directories to the skills source
                    for skill in "$SKILLS_TARGET"/*; do
                        if [ -d "$skill" ]; then
                            skill_name=$(basename "$skill")
                            if [ -d "$SKILLS_SOURCE/$skill_name" ]; then
                                warn "Skipping $skill_name (already exists in $SKILLS_SOURCE)"
                            else
                                mv "$skill" "$SKILLS_SOURCE/"
                                success "Moved $skill_name"
                            fi
                        fi
                    done

                    # Remove any remaining files and the directory
                    rm -rf "$SKILLS_TARGET"
                    success "Removed $SKILLS_TARGET"
                else
                    info "Aborted. Please handle $SKILLS_TARGET manually."
                    exit 1
                fi
            else
                # Directory is empty, just remove it
                rmdir "$SKILLS_TARGET"
                info "Removed empty directory: $SKILLS_TARGET"
            fi
        else
            warn "$SKILLS_TARGET exists but is not a symlink or directory."
            info "Please remove it manually: rm $SKILLS_TARGET"
            exit 1
        fi
    fi

    # Create the symlink
    ln -s "$SKILLS_SOURCE" "$SKILLS_TARGET"
    success "Created symlink: $SKILLS_TARGET -> $SKILLS_SOURCE"
}

# Parse arguments
case "${1:-}" in
    -D|--delete)
        delete_symlink
        ;;
    -h|--help)
        usage
        ;;
    "")
        create_symlink
        ;;
    *)
        fail "Unknown option: $1"
        usage
        exit 1
        ;;
esac
