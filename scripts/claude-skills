#!/bin/bash
#
# claude-skills - Symlink Claude skills to dotfiles
#
# Usage: claude-skills [-D|--delete]
#
# Creates a symlink from ~/.claude/skills to the dotfiles skills folder.
# Use -D or --delete to remove the symlink.

set -eu

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

# Source shared libraries
# shellcheck source=../lib/logging.sh
source "$REPO_DIR/lib/logging.sh"

CLAUDE_DIR="$HOME/.claude"
SKILLS_SOURCE="$REPO_DIR/skills"
SKILLS_TARGET="$CLAUDE_DIR/skills"

usage() {
    echo "Usage: claude-skills [-D|--delete]"
    echo ""
    echo "Options:"
    echo "  -D, --delete    Remove the skills symlink"
    echo "  -h, --help      Show this help message"
}

delete_symlink() {
    if [ -L "$SKILLS_TARGET" ]; then
        rm "$SKILLS_TARGET"
        success "Removed symlink: $SKILLS_TARGET"
    elif [ -e "$SKILLS_TARGET" ]; then
        fail "$SKILLS_TARGET exists but is not a symlink"
        exit 1
    else
        info "No symlink exists at $SKILLS_TARGET"
    fi
}

create_symlink() {
    # Ensure source exists
    if [ ! -d "$SKILLS_SOURCE" ]; then
        die "Skills directory not found: $SKILLS_SOURCE"
    fi

    # Create ~/.claude if it doesn't exist
    if [ ! -d "$CLAUDE_DIR" ]; then
        mkdir -p "$CLAUDE_DIR"
        info "Created directory: $CLAUDE_DIR"
    fi

    # Handle existing target
    if [ -L "$SKILLS_TARGET" ]; then
        current_target=$(readlink "$SKILLS_TARGET")
        if [ "$current_target" = "$SKILLS_SOURCE" ]; then
            success "Symlink already exists: $SKILLS_TARGET -> $SKILLS_SOURCE"
            return
        else
            warn "Removing existing symlink pointing to: $current_target"
            rm "$SKILLS_TARGET"
        fi
    elif [ -e "$SKILLS_TARGET" ]; then
        die "$SKILLS_TARGET exists and is not a symlink. Please remove it manually."
    fi

    # Create the symlink
    ln -s "$SKILLS_SOURCE" "$SKILLS_TARGET"
    success "Created symlink: $SKILLS_TARGET -> $SKILLS_SOURCE"
}

# Parse arguments
case "${1:-}" in
    -D|--delete)
        delete_symlink
        ;;
    -h|--help)
        usage
        ;;
    "")
        create_symlink
        ;;
    *)
        fail "Unknown option: $1"
        usage
        exit 1
        ;;
esac
