#!/bin/bash
#
# claude-skills - Symlink individual Claude skills to ~/.claude/skills
#
# Usage: claude-skills [options]
#
# Interactively select which skills from the dotfiles repo to symlink
# into ~/.claude/skills/ as individual folder symlinks.

set -eu

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"

# Source shared libraries
# shellcheck source=../lib/logging.sh
source "$REPO_DIR/lib/logging.sh"

CLAUDE_DIR="$HOME/.claude"
SKILLS_SOURCE="$REPO_DIR/skills"
SKILLS_TARGET="$CLAUDE_DIR/skills"

usage() {
    echo "Usage: claude-skills [options]"
    echo ""
    echo "Symlink individual Claude skills from dotfiles to ~/.claude/skills/"
    echo ""
    echo "Options:"
    echo "  -a, --all       Symlink all skills (non-interactive)"
    echo "  -D, --delete    Remove symlinked skills (interactive)"
    echo "  -l, --list      List skills and their status"
    echo "  -h, --help      Show this help message"
    echo ""
    echo "With no options, interactively select skills to symlink."
}

# Get available skills from the repo
get_repo_skills() {
    local skills=()
    for skill_dir in "$SKILLS_SOURCE"/*/; do
        [ -d "$skill_dir" ] || continue
        skills+=("$(basename "$skill_dir")")
    done
    echo "${skills[@]}"
}

# Check if a skill is already symlinked correctly
is_linked() {
    local name="$1"
    local target="$SKILLS_TARGET/$name"
    [ -L "$target" ] && [ "$(readlink "$target")" = "$SKILLS_SOURCE/$name" ]
}

# Check if a skill target exists but is not our symlink
is_conflict() {
    local name="$1"
    local target="$SKILLS_TARGET/$name"
    [ -e "$target" ] && ! is_linked "$name"
}

list_skills() {
    local skills
    read -ra skills <<< "$(get_repo_skills)"

    if [ ${#skills[@]} -eq 0 ]; then
        info "No skills found in $SKILLS_SOURCE"
        return
    fi

    echo ""
    for skill in "${skills[@]}"; do
        if is_linked "$skill"; then
            echo -e "  ${GREEN}●${NC} $skill ${DIM}(symlinked)${NC}"
        elif is_conflict "$skill"; then
            echo -e "  ${YELLOW}●${NC} $skill ${DIM}(exists, not symlinked)${NC}"
        else
            echo -e "  ${DIM}○${NC} $skill ${DIM}(not installed)${NC}"
        fi
    done
    echo ""
}

ensure_target_dir() {
    if [ -L "$SKILLS_TARGET" ]; then
        # Whole-directory symlink from old script — migrate
        local old_target
        old_target=$(readlink "$SKILLS_TARGET")
        warn "Found old whole-directory symlink: $SKILLS_TARGET -> $old_target"
        rm "$SKILLS_TARGET"
        mkdir -p "$SKILLS_TARGET"
        success "Converted to directory: $SKILLS_TARGET"
    elif [ ! -d "$SKILLS_TARGET" ]; then
        mkdir -p "$SKILLS_TARGET"
    fi
}

link_skill() {
    local name="$1"
    local source="$SKILLS_SOURCE/$name"
    local target="$SKILLS_TARGET/$name"

    if is_linked "$name"; then
        info "$name already symlinked"
        return
    fi

    if is_conflict "$name"; then
        warn "$name exists at $target but is not a symlink from dotfiles"
        read -p "  Replace it? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            info "Skipped $name"
            return
        fi
        rm -rf "$target"
    fi

    ln -s "$source" "$target"
    success "Linked $name"
}

unlink_skill() {
    local name="$1"
    local target="$SKILLS_TARGET/$name"

    if is_linked "$name"; then
        rm "$target"
        success "Unlinked $name"
    elif [ -e "$target" ]; then
        warn "$name exists but is not a dotfiles symlink, skipping"
    else
        info "$name is not installed"
    fi
}

interactive_link() {
    local skills
    read -ra skills <<< "$(get_repo_skills)"

    if [ ${#skills[@]} -eq 0 ]; then
        info "No skills found in $SKILLS_SOURCE"
        return
    fi

    echo ""
    info "Available skills in dotfiles:"
    echo ""

    local i=1
    for skill in "${skills[@]}"; do
        if is_linked "$skill"; then
            echo -e "  ${DIM}$i) $skill (already linked)${NC}"
        elif is_conflict "$skill"; then
            echo -e "  ${YELLOW}$i) $skill (conflict)${NC}"
        else
            echo "  $i) $skill"
        fi
        ((i++))
    done

    echo ""
    echo "  a) All skills"
    echo "  q) Quit"
    echo ""
    read -rp "  Select skills (comma-separated numbers, 'a' for all): " selection

    if [[ "$selection" == "q" ]]; then
        return
    fi

    ensure_target_dir

    if [[ "$selection" == "a" ]]; then
        for skill in "${skills[@]}"; do
            link_skill "$skill"
        done
        return
    fi

    IFS=',' read -ra choices <<< "$selection"
    for choice in "${choices[@]}"; do
        choice=$(echo "$choice" | tr -d ' ')
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#skills[@]} ]; then
            link_skill "${skills[$((choice - 1))]}"
        else
            warn "Invalid selection: $choice"
        fi
    done
}

interactive_delete() {
    local linked=()
    local skills
    read -ra skills <<< "$(get_repo_skills)"

    for skill in "${skills[@]}"; do
        if is_linked "$skill"; then
            linked+=("$skill")
        fi
    done

    if [ ${#linked[@]} -eq 0 ]; then
        info "No symlinked skills to remove"
        return
    fi

    echo ""
    info "Currently symlinked skills:"
    echo ""

    local i=1
    for skill in "${linked[@]}"; do
        echo "  $i) $skill"
        ((i++))
    done

    echo ""
    echo "  a) All"
    echo "  q) Quit"
    echo ""
    read -rp "  Select skills to remove (comma-separated numbers, 'a' for all): " selection

    if [[ "$selection" == "q" ]]; then
        return
    fi

    if [[ "$selection" == "a" ]]; then
        for skill in "${linked[@]}"; do
            unlink_skill "$skill"
        done
        return
    fi

    IFS=',' read -ra choices <<< "$selection"
    for choice in "${choices[@]}"; do
        choice=$(echo "$choice" | tr -d ' ')
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#linked[@]} ]; then
            unlink_skill "${linked[$((choice - 1))]}"
        else
            warn "Invalid selection: $choice"
        fi
    done
}

link_all() {
    local skills
    read -ra skills <<< "$(get_repo_skills)"

    if [ ${#skills[@]} -eq 0 ]; then
        info "No skills found in $SKILLS_SOURCE"
        return
    fi

    ensure_target_dir

    for skill in "${skills[@]}"; do
        link_skill "$skill"
    done
}

# Parse arguments
case "${1:-}" in
    -a|--all)
        link_all
        ;;
    -D|--delete)
        interactive_delete
        ;;
    -l|--list)
        list_skills
        ;;
    -h|--help)
        usage
        ;;
    "")
        interactive_link
        ;;
    *)
        fail "Unknown option: $1"
        usage
        exit 1
        ;;
esac
